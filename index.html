<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hem Chase Game</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #000;
  }
  canvas {
    display: block;
    background: url('A_2D_digital_illustration_depicts_a_school_hallway.png') no-repeat center center;
    background-size: cover;
  }
  #joystick {
    position: fixed;
    bottom: 50px;
    left: 50px;
    width: 100px;
    height: 100px;
    border: 2px solid white;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    touch-action: none;
  }
  #stick {
    position: absolute;
    left: 35px;
    top: 35px;
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 50%;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let player = {x: 200, y: 200, size: 50, speed: 3};
let hem = {x: 500, y: 500, size: 70, speed: 2};
let level = 1;
let jailTime = 0;
let keys = {};
let hemImg = new Image();
hemImg.src = "hem_cropped_transparent.png";

function speak(text) {
  let utter = new SpeechSynthesisUtterance(text);
  utter.voice = speechSynthesis.getVoices().find(v => v.lang.startsWith("en"));
  utter.rate = 1.2;
  utter.pitch = 1.0;
  speechSynthesis.speak(utter);
}

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function movePlayer() {
  if(keys["ArrowUp"] || keys["w"]) player.y -= player.speed;
  if(keys["ArrowDown"] || keys["s"]) player.y += player.speed;
  if(keys["ArrowLeft"] || keys["a"]) player.x -= player.speed;
  if(keys["ArrowRight"] || keys["d"]) player.x += player.speed;
}

function moveHem() {
  let dx = player.x - hem.x;
  let dy = player.y - hem.y;
  let dist = Math.sqrt(dx*dx + dy*dy);
  if(dist > 0) {
    hem.x += hem.speed * dx / dist;
    hem.y += hem.speed * dy / dist;
  }
}

function checkCatch() {
  let dx = player.x - hem.x;
  let dy = player.y - hem.y;
  let dist = Math.sqrt(dx*dx + dy*dy);
  if(dist < (player.size+hem.size)/2) {
    askQuestion();
  }
}

function askQuestion() {
  let formula = prompt("What is 5 x " + level + "?");
  if(formula == 5 * level) {
    speak("Correct! You may go.");
    level++;
    resetPositions();
  } else {
    speak("Wait! I will keep you till 9 PM and call your mother.");
    jailTime = 540; // 9 seconds at 60fps
  }
}

function resetPositions() {
  player.x = 200; player.y = 200;
  hem.x = 500; hem.y = 500;
}

function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(jailTime > 0) {
    jailTime--;
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "30px Arial";
    ctx.fillText("In Jail... " + Math.ceil(jailTime/60) + "s left", canvas.width/2-100, canvas.height/2);
  } else {
    movePlayer();
    moveHem();
    checkCatch();

    ctx.fillStyle = "blue";
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size/2, 0, Math.PI*2);
    ctx.fill();

    ctx.drawImage(hemImg, hem.x-hem.size/2, hem.y-hem.size/2, hem.size, hem.size);
  }

  requestAnimationFrame(gameLoop);
}
resetPositions();
gameLoop();

// Mobile joystick
let joystick = document.getElementById("joystick");
let stick = document.getElementById("stick");
let joy = {active:false, startX:0, startY:0, dx:0, dy:0};
joystick.addEventListener("touchstart", e=>{
  joy.active = true;
  joy.startX = e.touches[0].clientX;
  joy.startY = e.touches[0].clientY;
});
joystick.addEventListener("touchmove", e=>{
  let x = e.touches[0].clientX;
  let y = e.touches[0].clientY;
  joy.dx = x - joy.startX;
  joy.dy = y - joy.startY;
  stick.style.left = 35 + joy.dx/3 + "px";
  stick.style.top = 35 + joy.dy/3 + "px";
  player.x += player.speed * (joy.dx/50);
  player.y += player.speed * (joy.dy/50);
});
joystick.addEventListener("touchend", e=>{
  joy.active = false;
  joy.dx = 0; joy.dy = 0;
  stick.style.left = "35px";
  stick.style.top = "35px";
});
</script>
</body>
</html>
